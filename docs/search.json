[
  {
    "objectID": "index.html#set-parameters",
    "href": "index.html#set-parameters",
    "title": "Proportional Fleet Redistribution",
    "section": "2. Set Parameters",
    "text": "2. Set Parameters\nAssign titles, timeframe, and closures\n\n\nCode\n# Parameters\nspp_title = \"Species\"\ntitle_name = \"Closure\"\ntimeframe &lt;- c(2011:2023)\nclosure.stat.areas &lt;- c(665730, 665700, 655730, 655700)"
  },
  {
    "objectID": "index.html#spatial-data-and-grid-setup",
    "href": "index.html#spatial-data-and-grid-setup",
    "title": "Proportional Fleet Redistribution",
    "section": "3. Spatial Data and Grid Setup",
    "text": "3. Spatial Data and Grid Setup\nLoading the Alaska background and statistical area shapefiles to create the time-series grid.\n\n\nCode\n# Note: Ensure these paths are relative to your .qmd file location\nAK &lt;- terra::vect(\"shapefiles/mv_alaska_1mil_py.shp\")\nstat_areas &lt;- terra::vect(\"shapefiles/State_Stat_2004.shp\")\nstat_areas$STAT_AREA &lt;- as.numeric(stat_areas$STAT_AREA)\n\n# Create timeseries list\nstat.list &lt;- list()\nfor (i in timeframe){\n  stat_shape &lt;- stat_areas\n  stat_shape$YEAR &lt;- i\n  stat.list[[as.character(i)]] &lt;- stat_shape\n}\nstat.areas.timeseries &lt;- terra::vect(stat.list)"
  },
  {
    "objectID": "index.html#closure-assignment",
    "href": "index.html#closure-assignment",
    "title": "Proportional Fleet Redistribution",
    "section": "4. Closure Assignment",
    "text": "4. Closure Assignment\nDefining the closure area based on specific statistical areas.\n\n\nCode\nclosure &lt;- subset(stat_areas, stat_areas$STAT_AREA %in% closure.stat.areas)\nclosure$closed &lt;- \"yes\"\nclosure2 &lt;- terra::aggregate(closure)\n\nnon_closure &lt;- stat_areas[!(stat_areas$STAT_AREA %in% closure.stat.areas), ]\nnon_closure$closed &lt;- \"no\""
  },
  {
    "objectID": "index.html#simulation-data",
    "href": "index.html#simulation-data",
    "title": "Proportional Fleet Redistribution",
    "section": "5. Simulation Data",
    "text": "5. Simulation Data\nSimulating weekly catch data for 20 cells closest to the closure area. This is where you would also enter your own catch data. Here, we’re also simulating a bias of higher PSC inside the hypothetical closure.\n\n\nCode\n# --- 5. Simulation Data (Biased for high PSC inside closure) ---\n\nset.seed(123)\nnum_to_select &lt;- 20\n\n# 1. Calculate distances from non-closure to closure areas\ndistances_to_closure &lt;- terra::distance(non_closure, closure2)\nmin_distances &lt;- apply(distances_to_closure, MARGIN = 1, FUN = min)\nnon_closure$dist_to_closure &lt;- min_distances\n\n# 2. Select 20 areas outside but close to the closure\nnon_closure_ordered &lt;- non_closure[order(non_closure$dist_to_closure), ]\nsim_areas &lt;- non_closure_ordered %&gt;% slice(1:num_to_select)\n\n# 3. Merge back closure areas\nsim_areas &lt;- rbind(sim_areas, closure)\n\n# 4. Generate Weekly Data with PSC Bias\nsimulated_years &lt;- c(2021, 2022, 2023)\nsim.list &lt;- list()\n\nfor(i in simulated_years){\n  \n  # Create a sequence of 5 weeks starting in August for each year\n  week_sequence &lt;- seq.Date(from = as.Date(paste0(i, \"-08-01\")), \n                            by = \"week\", length.out = 5)\n  year_weeks_list &lt;- list()\n  \n  for(week_date in as.character(week_sequence)) {\n    \n    # Identify which rows are inside the closure for this specific loop\n    is_inside &lt;- sim_areas$STAT_AREA %in% closure.stat.areas\n    num_inside &lt;- sum(is_inside)\n    num_outside &lt;- sum(!is_inside)\n    \n    # Create the data frame\n    wk_dat &lt;- data.frame(\n      STAT_AREA = sim_areas$STAT_AREA,\n      YEAR = i,\n      WEEK_END_DATE = week_date,\n      CATCH_ACTIVITY_DATE = as.character(as.Date(week_date) - 2),\n      PROCESSING_SECTOR = \"X\"\n    )\n    \n    # Generate Groundfish catch (kept consistent across all areas)\n    wk_dat$GF_TOTAL_CATCH_MT &lt;- round(rnorm(nrow(sim_areas), mean = 50, sd = 10), 2)\n    \n    # Generate PSC catch with Bias:\n    wk_dat$PSC_TOTAL_COUNT &lt;- NA # Initialize\n    \n    # Higher PSC mean for inside areas (e.g., mean = 15)\n    wk_dat$PSC_TOTAL_COUNT[is_inside] &lt;- round(rnorm(num_inside, mean = 10, sd = 3), 2)\n    \n    # Lower PSC mean for outside areas (e.g., mean = 5)\n    wk_dat$PSC_TOTAL_COUNT[!is_inside] &lt;- round(rnorm(num_outside, mean = 5, sd = 2), 2)\n    \n    year_weeks_list[[week_date]] &lt;- wk_dat\n  }\n  sim.list[[as.character(i)]] &lt;- do.call(rbind, year_weeks_list)\n}\n\ncatch_data &lt;- do.call(rbind, sim.list)\n\n# 5. Merge catch data with spatvector\n# Using all.x = FALSE ensures the map only displays areas with data\ncatch_data2 &lt;- merge(stat_areas, catch_data, by = \"STAT_AREA\", all.x = FALSE)"
  },
  {
    "objectID": "index.html#visualizations",
    "href": "index.html#visualizations",
    "title": "Proportional Fleet Redistribution",
    "section": "6. Visualizations",
    "text": "6. Visualizations\nWeekly groundfish catch - simulated to be randomly distributed across the study area (closure + 20 adjacent stat areas).\n\n\nCode\nggplot() +\n  tidyterra::geom_spatvector(data = catch_data2, aes(fill = GF_TOTAL_CATCH_MT), \n                             alpha = 0.8, col = NA, na.rm = TRUE) +\n  scale_fill_distiller(palette = \"GnBu\", name = \"Catch (MT)\") +\n  tidyterra::geom_spatvector(data = closure2, aes(color = \"Closure\"), \n                             fill = NA, alpha = 0.5, lwd = 0.5) +\n  scale_color_manual(values = c(\"Closure\" = \"red\"), name = NULL) +\n  facet_wrap(~WEEK_END_DATE, ncol=5) +\n  theme_bw() + theme(plot.title = element_text(hjust = 0.5), axis.title = element_blank())\n\n\n\n\n\n\n\n\nFigure 1: Simulated weekly groundfish catch distributions.\n\n\n\n\n\nWeekly PSC catch - simulated to have higher PSC within the hypothetical closure.\n\n\nCode\nggplot() +\n  tidyterra::geom_spatvector(data = catch_data2, aes(fill = PSC_TOTAL_COUNT), \n                             alpha = 0.8, col = NA, na.rm = TRUE) +\n  scale_fill_distiller(palette = \"GnBu\", name = \"PSC Catch (Number)\") +\n  tidyterra::geom_spatvector(data = closure2, aes(color = \"Closure\"), \n                             fill = NA, alpha = 0.5, lwd = 0.5) +\n  scale_color_manual(values = c(\"Closure\" = \"red\"), name = NULL) +\n  facet_wrap(~WEEK_END_DATE, ncol=5) +\n  theme_bw() + theme(plot.title = element_text(hjust = 0.5), axis.title = element_blank())\n\n\n\n\n\n\n\n\nFigure 2: Simulated weekly PSC distributions."
  },
  {
    "objectID": "index.html#assign-closure-dates-isolate-impacted-hauls",
    "href": "index.html#assign-closure-dates-isolate-impacted-hauls",
    "title": "Proportional Fleet Redistribution",
    "section": "7. Assign Closure Dates & Isolate Impacted Hauls",
    "text": "7. Assign Closure Dates & Isolate Impacted Hauls\nFor this exercise, July 1 chosen as the closure date for each year. For year-long closures, choose January 1.\n\n\nCode\n#| label: impacted-hauls\n#| echo: false\n\n#sum status quo PSC by year for later joins\nall_psc_status_quo_annual &lt;- as.data.frame(catch_data2) %&gt;%\n  group_by(YEAR) %&gt;%\n  reframe(\n    sum_psc_status_quo = sum(PSC_TOTAL_COUNT)\n  )\n\n#assign dates to data ---\n#set closure date\nclosure_dates &lt;- data.frame(\n  YEAR = c(2021,2022,2023),\n  PROCESSING_SECTOR = \"X\",\n  closure_date = c('2021-07-01','2022-07-01', '2023-07-01')\n)\n\n#assign dates\nall_psc_closures_dates &lt;- as.data.frame(dplyr::left_join(catch_data2, closure_dates, by=c(\"YEAR\", \"PROCESSING_SECTOR\")))\n\n\n#assign groundfish and psc based on date ---\nall_psc_closures_dates$closure &lt;- ifelse(!is.na(all_psc_closures_dates$closure_date), \"yes\", \"no\")\nall_psc_closures_dates$impacted &lt;- ifelse(all_psc_closures_dates$CATCH_ACTIVITY_DATE &gt; all_psc_closures_dates$closure_date, \"yes\", \"no\")\nall_psc_closures_dates$tons_gf_after_closure &lt;- ifelse(all_psc_closures_dates$impacted==\"yes\", all_psc_closures_dates$GF_TOTAL_CATCH_MT, 0)\nall_psc_closures_dates$tons_gf_no_closure &lt;- ifelse(all_psc_closures_dates$impacted==\"no\" | is.na(all_psc_closures_dates$impacted), all_psc_closures_dates$GF_TOTAL_CATCH_MT, 0)\n\n\n#isolate impacted hauls\nall_psc_impacted &lt;- subset(all_psc_closures_dates, impacted==\"yes\")"
  },
  {
    "objectID": "index.html#calculate-catch-and-proportions-insideoutside-closure",
    "href": "index.html#calculate-catch-and-proportions-insideoutside-closure",
    "title": "Proportional Fleet Redistribution",
    "section": "8. Calculate Catch and Proportions Inside/Outside Closure",
    "text": "8. Calculate Catch and Proportions Inside/Outside Closure\nThis step summarizes the data used in the main calculations - the proportions of outside groundish catch where displaced catch is applied to, under the assumption that the fishery will meet the same overall total catch, the total catch inside the closure to be applied to the proportions, the new PSC as a result of the new GF catch applied to local PSC rates, and the PSC caught inside the closure that will be subtracted from the net total.\n\n\nCode\n#| label: rates-props\n#| echo: false\n\n# Identify Inside/Outside after a closure would have occurred  ---\n\n#identify the area\nstat_areas_closed &lt;- closure.stat.areas \n\n#identify which hauls occurred inside/outside the closed area\nall_psc_impacted_cluster &lt;- all_psc_impacted %&gt;%\n  mutate(inside = case_when(STAT_AREA %in% c(stat_areas_closed) ~ \"yes\", TRUE ~ NA_character_))\nall_psc_impacted_cluster$inside[is.na(all_psc_impacted_cluster$inside)] &lt;- \"no\" # NA cpue to 0s\n\n\n# -- inside catch -- #\n#isolate hauls occurring inside closed area\ngf_inside_cluster &lt;- subset(all_psc_impacted_cluster, inside == \"yes\")\n\n#sum gf and psc inside closed area for later calcs\ngf_inside_cluster2 &lt;- gf_inside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, PROCESSING_SECTOR) %&gt;%\n  summarise(\n    tons_gf_inside_wk = sum(GF_TOTAL_CATCH_MT),\n    psc_measure_inside_wk = sum(PSC_TOTAL_COUNT)\n  )\n\n# -- outside catch -- #\n#isolate the hauls that occurred outside the closed area\ngf_outside_cluster &lt;- subset(all_psc_impacted_cluster, inside == \"no\")\n\ngf_outside_cluster2 &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, PROCESSING_SECTOR) %&gt;%\n  summarise(\n    tons_gf_outside_wk = sum(GF_TOTAL_CATCH_MT),\n    psc_measure_outside_wk = sum(PSC_TOTAL_COUNT)\n  )\n\n\n# summarize mean psc rates and calculate ratio of means  ---\n\nsum.stat.timeseries.gf_all &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, STAT_AREA, PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_wk = sum(GF_TOTAL_CATCH_MT),\n    mean_psc_wk = mean(PSC_TOTAL_COUNT),\n    mean_gf_tons_wk = mean(GF_TOTAL_CATCH_MT)) \n\n#ratio\nsum.stat.timeseries.gf_all$mean_psc_rate_wk &lt;- sum.stat.timeseries.gf_all$mean_psc_wk/sum.stat.timeseries.gf_all$mean_gf_tons_wk\n\n\n# Proportions by YEAR and STAT_AREA  ---\n\n#isolate gf catch by week\ngf.outside.stat &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, STAT_AREA, PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_annual_stat = sum(GF_TOTAL_CATCH_MT)\n  )\n\n# sum all catch outside\ngf.outside.annually &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE,  PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_annual = sum(GF_TOTAL_CATCH_MT))\n\n#join the the sums back to main\nsum.stat.timeseries.gf_all2 &lt;- dplyr::left_join(sum.stat.timeseries.gf_all, gf.outside.annually, by = c(\"YEAR\", \"WEEK_END_DATE\", \"PROCESSING_SECTOR\"))\nsum.stat.timeseries.gf_all3 &lt;- dplyr::left_join(sum.stat.timeseries.gf_all2, gf.outside.stat, by = c(\"YEAR\",\"WEEK_END_DATE\", \"STAT_AREA\", \"PROCESSING_SECTOR\"))\n\n# CALC PROPORTION OF OUTSIDE CATCH FOR EACH AREA\nsum.stat.timeseries.gf_all3$proportion_outside_wk &lt;- sum.stat.timeseries.gf_all3$tons_gf_annual_stat/sum.stat.timeseries.gf_all3$tons_gf_annual\nsum.stat.timeseries.gf_all3 &lt;- as.data.frame(sum.stat.timeseries.gf_all3)"
  },
  {
    "objectID": "index.html#plot-weekly-proportions",
    "href": "index.html#plot-weekly-proportions",
    "title": "Proportional Fleet Redistribution",
    "section": "9. Plot Weekly Proportions",
    "text": "9. Plot Weekly Proportions\nThis plot shows the proportions of groundfish catch for the 20 adjacent stat areas outside of the closure. These proportions will be what displaced catch is applied to, under the assumption that the fishery will meet the same overall total catch.\n\n\nCode\n#proportion\nsum.stat.timeseries.gf_all_shp &lt;- dplyr::left_join(stat.areas.timeseries, sum.stat.timeseries.gf_all3, by=c(\"YEAR\", \"STAT_AREA\"))\nsum.stat.timeseries.gf_all_shp &lt;- terra::na.omit(sum.stat.timeseries.gf_all_shp, \"PROCESSING_SECTOR\")\n\npropdat &lt;- sum.stat.timeseries.gf_all_shp\npropdat$label &lt;- round(propdat$proportion_outside_wk, 2)\n\nggplot() +\n  tidyterra::geom_spatvector(data=subset(propdat, propdat$proportion_outside_wk&gt;0), aes(fill=proportion_outside_wk), alpha = 0.8, col=NA, na.rm=TRUE) +\n  scale_fill_distiller(palette = \"GnBu\", name = \"Proportion of GF Catch\") +\n  tidyterra::geom_spatvector(data = closure2, aes(color = \"Closure\"), \n                             fill = NA, alpha = 0.5, lwd = 0.5) +\n  scale_color_manual(values = c(\"Closure\" = \"red\"), name = NULL) +\n  facet_wrap(~WEEK_END_DATE, ncol=5) +\n  theme_bw() + theme(plot.title = element_text(hjust = 0.5), axis.title = element_blank())\n\n\n\n\n\n\n\n\nFigure 3: Simulated weekly GF Catch Proportions."
  },
  {
    "objectID": "index.html#calculate-weekly-and-annual-summary-statistics",
    "href": "index.html#calculate-weekly-and-annual-summary-statistics",
    "title": "Proportional Fleet Redistribution",
    "section": "10. Calculate Weekly and Annual Summary Statistics",
    "text": "10. Calculate Weekly and Annual Summary Statistics\n\n\nCode\n#| label: summary-stats\n#| echo: false\n\n#join catch from inside area\ntotal.join &lt;- dplyr::left_join(sum.stat.timeseries.gf_all3,\n                               gf_inside_cluster2 %&gt;% dplyr::select(YEAR, WEEK_END_DATE, PROCESSING_SECTOR, tons_gf_inside_wk),\n                               by=c(\"YEAR\", \"WEEK_END_DATE\",  \"PROCESSING_SECTOR\"))\n\n#NAs to 0s to remove weeks where no catch happened inside the closed area\ntotal.join$tons_gf_inside_wk[is.na(total.join$tons_gf_inside_wk)] &lt;- 0\n\n#multiply weekly displaced catch by the outside proportions\ntotal.join$displaced_gf_catch_wk &lt;- total.join$tons_gf_inside_wk * total.join$proportion_outside_wk\n\n#multiply PSC rate by new gf catch\ntotal.join$new_PSC_wk &lt;- total.join$displaced_gf_catch_wk * total.join$mean_psc_rate_wk\n\n\n#summarize by week and sector\ntotal.join2 &lt;- total.join %&gt;% group_by(YEAR, WEEK_END_DATE, PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_inside_wk = max(tons_gf_inside_wk),\n    displaced_gf_catch_wk = sum(displaced_gf_catch_wk),\n    new_PSC_wk = sum(new_PSC_wk),\n    mean_psc_rate_wk = mean(mean_psc_rate_wk))\n\n#join the status quo inside psc numbers\ntotal.join3 &lt;- dplyr::left_join(total.join2,\n                                gf_inside_cluster2 %&gt;% dplyr::select(YEAR, WEEK_END_DATE, PROCESSING_SECTOR, psc_measure_inside_wk),\n                                by=c(\"YEAR\", \"WEEK_END_DATE\", \"PROCESSING_SECTOR\"))\n#NAs to 0s\ntotal.join3$psc_measure_inside_wk[is.na(total.join3$psc_measure_inside_wk)] &lt;- 0\n\n#subtract the PSC caught inside the area\ntotal.join3$net_change_PSC_wk &lt;- total.join3$new_PSC_wk - total.join3$psc_measure_inside_wk\n\ntotal.join.plot &lt;- total.join3\n\n\n#sum est changes for annual numbers\ntotal.join.plot.annual &lt;- total.join.plot %&gt;%\n  group_by(YEAR) %&gt;%\n  reframe(\n    est_change_fleet = sum(net_change_PSC_wk)\n  )"
  },
  {
    "objectID": "index.html#status-quo-comparison",
    "href": "index.html#status-quo-comparison",
    "title": "Proportional Fleet Redistribution",
    "section": "12. Status Quo Comparison",
    "text": "12. Status Quo Comparison\n\n\nCode\n# --- 12. Final Status Quo Comparison ---\n\n# 1. Clean build of the annual comparison data\ntotal.join.plot.annual_clean &lt;- all_psc_status_quo_annual %&gt;%\n  left_join(total.join.plot.annual, by = \"YEAR\") %&gt;%\n  rename(psc_statusquo = sum_psc_status_quo, \n         psc_change = est_change_fleet) %&gt;%\n  mutate(psc_change = replace_na(psc_change, 0),\n         net_new_PSC = psc_statusquo + psc_change) %&gt;%\n  left_join(boot_annual_ci, by = \"YEAR\") %&gt;%\n  # 2. THE VERTICAL FIX: \n  # Calculate the distance from the bootstrap result to the bootstrap mean\n  # then apply THAT distance to your actual bar height (net_new_PSC)\n  mutate(\n    # Find the 'spread' of the bootstrap distribution\n    boot_mean = (upper_change + lower_change) / 2, # Using the mid-point of the bootstrap\n    half_width_lower = boot_mean - lower_change,\n    half_width_upper = upper_change - boot_mean,\n    \n    # Apply that spread relative to your ACTUAL bar height\n    ymin_val = net_new_PSC - half_width_lower,\n    ymax_val = net_new_PSC + half_width_upper\n  ) %&gt;%\n  # 3. Pivot for ggplot\n  pivot_longer(\n    cols = c(\"net_new_PSC\", \"psc_statusquo\"),\n    names_to = \"psc_type\",\n    values_to = \"psc_amount\"\n  ) %&gt;%\n  mutate(\n    ymin = ifelse(psc_type == \"net_new_PSC\", ymin_val, NA),\n    ymax = ifelse(psc_type == \"net_new_PSC\", ymax_val, NA)\n  ) %&gt;%\n  distinct()\n\n# 4. Final Plot \ny_min &lt;- min(total.join.plot.annual_clean$psc_amount, na.rm = TRUE) * 0.9\ny_max &lt;- max(total.join.plot.annual_clean$ymax, na.rm = TRUE) * 1.15 # Manual expansion\n\nggplot(total.join.plot.annual_clean, aes(x = factor(YEAR), y = psc_amount, fill = psc_type)) + \n  geom_bar(stat = \"identity\", position = position_dodge(0.9)) + \n  geom_errorbar(aes(ymin = ymin, ymax = ymax), \n                position = position_dodge(0.9), \n                width = 0.25, \n                na.rm = TRUE) +\n  # THE FIX: Use coord_cartesian to zoom WITHOUT deleting the bar data\n  # We set both the bottom (y_min) and the top (y_max) here\n  coord_cartesian(ylim = c(y_min, y_max)) + \n  theme_bw() + \n  labs(title = paste0(spp_title, \": \", title_name),\n       x = \"Year\", \n       y = \"Estimated Annual PSC (# Fish)\") +\n  scale_fill_brewer(palette = \"Paired\", \n                    name = \"Scenario\", \n                    labels = c(\"Closure (with 95% CI)\", \"Status Quo\")) +\n  theme(plot.title = element_text(hjust = 0.5))\n\n\n\n\n\n\n\n\nFigure 4"
  },
  {
    "objectID": "index.html#final-summary-statistics-table",
    "href": "index.html#final-summary-statistics-table",
    "title": "Proportional Fleet Redistribution",
    "section": "13. Final Summary Statistics Table",
    "text": "13. Final Summary Statistics Table\n\n\nCode\n# Re-align with the original script's naming convention\ntotal.join.plot.annual2 &lt;- all_psc_status_quo_annual %&gt;%\n  left_join(total.join.plot.annual, by = \"YEAR\") %&gt;%\n  rename(psc_statusquo = sum_psc_status_quo, \n         psc_change = est_change_fleet) %&gt;%\n  mutate(psc_change = replace_na(psc_change, 0),\n         net_new_PSC = psc_statusquo + psc_change) %&gt;%\n  left_join(boot_annual_ci, by = \"YEAR\") %&gt;%\n  # Add the CI bounds we calculated for the plot\n  mutate(\n    lower_diff = psc_change - lower_change,\n    upper_diff = upper_change - psc_change,\n    ymin_val = net_new_PSC - lower_diff,\n    ymax_val = net_new_PSC + upper_diff\n  )\n\n# Create the final summary table\nfinal.summary.table &lt;- total.join.plot.annual2 %&gt;% \n  dplyr::select(YEAR, psc_statusquo, net_new_PSC, ymin_val, ymax_val, psc_change)\n\n# Format for the report\nfinal.summary.table &lt;- as.data.frame(final.summary.table)\ncolnames(final.summary.table) &lt;- c(\"year\", \"PSC_status_quo\", \"PSC_closure\", \"lowerCI_closure\", \"upperCI_closure\", \"Net_Change\")\n\n# Calculate percent change\nfinal.summary.table$percent_change &lt;- (final.summary.table$Net_Change / final.summary.table$PSC_status_quo) * 100\n\n# Render as a professional HTML table for Quarto\nlibrary(knitr)\nkable(final.summary.table, \n      digits = 2, \n      caption = \"Annual PSC Comparison: Status Quo vs. Closure Scenarios\")\n\n\n\nAnnual PSC Comparison: Status Quo vs. Closure Scenarios\n\n\n\n\n\n\n\n\n\n\n\nyear\nPSC_status_quo\nPSC_closure\nlowerCI_closure\nupperCI_closure\nNet_Change\npercent_change\n\n\n\n\n2021\n692.42\n604.98\n600.22\n616.52\n-87.44\n-12.63\n\n\n2022\n734.77\n638.74\n633.03\n653.45\n-96.03\n-13.07\n\n\n2023\n686.12\n608.01\n602.80\n619.09\n-78.11\n-11.38"
  },
  {
    "objectID": "FMM.html#set-parameters",
    "href": "FMM.html#set-parameters",
    "title": "Proportional Groundfish Redistribution",
    "section": "2. Set Parameters",
    "text": "2. Set Parameters\nAssign titles, timeframe, and closures\n\n\nCode\n# Parameters\nspp_title = \"Species\"\ntitle_name = \"Closure\"\ntimeframe &lt;- c(2011:2023)\nclosure.stat.areas &lt;- c(665730, 665700, 655730, 655700)"
  },
  {
    "objectID": "FMM.html#spatial-data-and-grid-setup",
    "href": "FMM.html#spatial-data-and-grid-setup",
    "title": "Proportional Groundfish Redistribution",
    "section": "3. Spatial Data and Grid Setup",
    "text": "3. Spatial Data and Grid Setup\nLoading the Alaska background and statistical area shapefiles to create the time-series grid.\n\n\nCode\n# Note: Ensure these paths are relative to your .qmd file location\nAK &lt;- terra::vect(\"shapefiles/mv_alaska_1mil_py.shp\")\nstat_areas &lt;- terra::vect(\"shapefiles/State_Stat_2004.shp\")\nstat_areas$STAT_AREA &lt;- as.numeric(stat_areas$STAT_AREA)\n\n# Create timeseries list\nstat.list &lt;- list()\nfor (i in timeframe){\n  stat_shape &lt;- stat_areas\n  stat_shape$YEAR &lt;- i\n  stat.list[[as.character(i)]] &lt;- stat_shape\n}\nstat.areas.timeseries &lt;- terra::vect(stat.list)"
  },
  {
    "objectID": "FMM.html#closure-assignment",
    "href": "FMM.html#closure-assignment",
    "title": "Proportional Groundfish Redistribution",
    "section": "4. Closure Assignment",
    "text": "4. Closure Assignment\nDefining the closure area based on specific statistical areas.\n\n\nCode\nclosure &lt;- subset(stat_areas, stat_areas$STAT_AREA %in% closure.stat.areas)\nclosure$closed &lt;- \"yes\"\nclosure2 &lt;- terra::aggregate(closure)\n\nnon_closure &lt;- stat_areas[!(stat_areas$STAT_AREA %in% closure.stat.areas), ]\nnon_closure$closed &lt;- \"no\""
  },
  {
    "objectID": "FMM.html#simulation-data",
    "href": "FMM.html#simulation-data",
    "title": "Proportional Groundfish Redistribution",
    "section": "5. Simulation Data",
    "text": "5. Simulation Data\nSimulating weekly catch data for 20 cells closest to the closure area. This is where you would also enter your own catch data. Here, we’re also simulating a bias of higher PSC inside the hypothetical closure.\n\n\nCode\n# --- 5. Simulation Data (Biased for high PSC inside closure) ---\n\nset.seed(123)\nnum_to_select &lt;- 20\n\n# 1. Calculate distances from non-closure to closure areas\ndistances_to_closure &lt;- terra::distance(non_closure, closure2)\nmin_distances &lt;- apply(distances_to_closure, MARGIN = 1, FUN = min)\nnon_closure$dist_to_closure &lt;- min_distances\n\n# 2. Select 20 areas outside but close to the closure\nnon_closure_ordered &lt;- non_closure[order(non_closure$dist_to_closure), ]\nsim_areas &lt;- non_closure_ordered %&gt;% slice(1:num_to_select)\n\n# 3. Merge back closure areas\nsim_areas &lt;- rbind(sim_areas, closure)\n\n# 4. Generate Weekly Data with PSC Bias\nsimulated_years &lt;- c(2021, 2022, 2023)\nsim.list &lt;- list()\n\nfor(i in simulated_years){\n  \n  # Create a sequence of 5 weeks starting in August for each year\n  week_sequence &lt;- seq.Date(from = as.Date(paste0(i, \"-08-01\")), \n                            by = \"week\", length.out = 5)\n  year_weeks_list &lt;- list()\n  \n  for(week_date in as.character(week_sequence)) {\n    \n    # Identify which rows are inside the closure for this specific loop\n    is_inside &lt;- sim_areas$STAT_AREA %in% closure.stat.areas\n    num_inside &lt;- sum(is_inside)\n    num_outside &lt;- sum(!is_inside)\n    \n    # Create the data frame\n    wk_dat &lt;- data.frame(\n      STAT_AREA = sim_areas$STAT_AREA,\n      YEAR = i,\n      WEEK_END_DATE = week_date,\n      CATCH_ACTIVITY_DATE = as.character(as.Date(week_date) - 2),\n      PROCESSING_SECTOR = \"X\"\n    )\n    \n    # Generate Groundfish catch (kept consistent across all areas)\n    wk_dat$GF_TOTAL_CATCH_MT &lt;- round(rnorm(nrow(sim_areas), mean = 50, sd = 10), 2)\n    \n    # Generate PSC catch with Bias:\n    wk_dat$PSC_TOTAL_COUNT &lt;- NA # Initialize\n    \n    # Higher PSC mean for inside areas (e.g., mean = 15)\n    wk_dat$PSC_TOTAL_COUNT[is_inside] &lt;- round(rnorm(num_inside, mean = 10, sd = 3), 2)\n    \n    # Lower PSC mean for outside areas (e.g., mean = 5)\n    wk_dat$PSC_TOTAL_COUNT[!is_inside] &lt;- round(rnorm(num_outside, mean = 5, sd = 2), 2)\n    \n    year_weeks_list[[week_date]] &lt;- wk_dat\n  }\n  sim.list[[as.character(i)]] &lt;- do.call(rbind, year_weeks_list)\n}\n\ncatch_data &lt;- do.call(rbind, sim.list)\n\n# 5. Merge catch data with spatvector\n# Using all.x = FALSE ensures the map only displays areas with data\ncatch_data2 &lt;- merge(stat_areas, catch_data, by = \"STAT_AREA\", all.x = FALSE)"
  },
  {
    "objectID": "FMM.html#visualizations",
    "href": "FMM.html#visualizations",
    "title": "Proportional Groundfish Redistribution",
    "section": "6. Visualizations",
    "text": "6. Visualizations\nWeekly groundfish catch - simulated to be randomly distributed across the study area (closure + 20 adjacent stat areas).\n\n\nCode\nggplot() +\n  tidyterra::geom_spatvector(data = catch_data2, aes(fill = GF_TOTAL_CATCH_MT), \n                             alpha = 0.8, col = NA, na.rm = TRUE) +\n  scale_fill_distiller(palette = \"GnBu\", name = \"Catch (MT)\") +\n  tidyterra::geom_spatvector(data = closure2, aes(color = \"Closure\"), \n                             fill = NA, alpha = 0.5, lwd = 0.5) +\n  scale_color_manual(values = c(\"Closure\" = \"red\"), name = NULL) +\n  facet_wrap(~WEEK_END_DATE, ncol=5) +\n  theme_bw() + theme(plot.title = element_text(hjust = 0.5), axis.title = element_blank())\n\n\n\n\n\n\n\n\nFigure 1: Simulated weekly groundfish catch distributions.\n\n\n\n\n\nWeekly PSC catch - simulated to have higher PSC within the hypothetical closure.\n\n\nCode\nggplot() +\n  tidyterra::geom_spatvector(data = catch_data2, aes(fill = PSC_TOTAL_COUNT), \n                             alpha = 0.8, col = NA, na.rm = TRUE) +\n  scale_fill_distiller(palette = \"GnBu\", name = \"PSC Catch (Number)\") +\n  tidyterra::geom_spatvector(data = closure2, aes(color = \"Closure\"), \n                             fill = NA, alpha = 0.5, lwd = 0.5) +\n  scale_color_manual(values = c(\"Closure\" = \"red\"), name = NULL) +\n  facet_wrap(~WEEK_END_DATE, ncol=5) +\n  theme_bw() + theme(plot.title = element_text(hjust = 0.5), axis.title = element_blank())\n\n\n\n\n\n\n\n\nFigure 2: Simulated weekly PSC distributions."
  },
  {
    "objectID": "FMM.html#assign-closure-dates-isolate-impacted-hauls",
    "href": "FMM.html#assign-closure-dates-isolate-impacted-hauls",
    "title": "Proportional Groundfish Redistribution",
    "section": "7. Assign Closure Dates & Isolate Impacted Hauls",
    "text": "7. Assign Closure Dates & Isolate Impacted Hauls\nFor this exercise, July 1 chosen as the closure date for each year. For year-long closures, choose January 1.\n\n\nCode\n#| label: impacted-hauls\n#| echo: false\n\n#sum status quo PSC by year for later joins\nall_psc_status_quo_annual &lt;- as.data.frame(catch_data2) %&gt;%\n  group_by(YEAR) %&gt;%\n  reframe(\n    sum_psc_status_quo = sum(PSC_TOTAL_COUNT)\n  )\n\n#assign dates to data ---\n#set closure date\nclosure_dates &lt;- data.frame(\n  YEAR = c(2021,2022,2023),\n  PROCESSING_SECTOR = \"X\",\n  closure_date = c('2021-07-01','2022-07-01', '2023-07-01')\n)\n\n#assign dates\nall_psc_closures_dates &lt;- as.data.frame(dplyr::left_join(catch_data2, closure_dates, by=c(\"YEAR\", \"PROCESSING_SECTOR\")))\n\n\n#assign groundfish and psc based on date ---\nall_psc_closures_dates$closure &lt;- ifelse(!is.na(all_psc_closures_dates$closure_date), \"yes\", \"no\")\nall_psc_closures_dates$impacted &lt;- ifelse(all_psc_closures_dates$CATCH_ACTIVITY_DATE &gt; all_psc_closures_dates$closure_date, \"yes\", \"no\")\nall_psc_closures_dates$tons_gf_after_closure &lt;- ifelse(all_psc_closures_dates$impacted==\"yes\", all_psc_closures_dates$GF_TOTAL_CATCH_MT, 0)\nall_psc_closures_dates$tons_gf_no_closure &lt;- ifelse(all_psc_closures_dates$impacted==\"no\" | is.na(all_psc_closures_dates$impacted), all_psc_closures_dates$GF_TOTAL_CATCH_MT, 0)\n\n\n#isolate impacted hauls\nall_psc_impacted &lt;- subset(all_psc_closures_dates, impacted==\"yes\")"
  },
  {
    "objectID": "FMM.html#calculate-catch-and-proportions-insideoutside-closure",
    "href": "FMM.html#calculate-catch-and-proportions-insideoutside-closure",
    "title": "Proportional Groundfish Redistribution",
    "section": "8. Calculate Catch and Proportions Inside/Outside Closure",
    "text": "8. Calculate Catch and Proportions Inside/Outside Closure\nThis step summarizes the data used in the main calculations - the proportions of outside groundish catch where displaced catch is applied to, under the assumption that the fishery will meet the same overall total catch, the total catch inside the closure to be applied to the proportions, the new PSC as a result of the new GF catch applied to local PSC rates, and the PSC caught inside the closure that will be subtracted from the net total.\n\n\nCode\n#| label: rates-props\n#| echo: false\n\n# Identify Inside/Outside after a closure would have occurred  ---\n\n#identify the area\nstat_areas_closed &lt;- closure.stat.areas \n\n#identify which hauls occurred inside/outside the closed area\nall_psc_impacted_cluster &lt;- all_psc_impacted %&gt;%\n  mutate(inside = case_when(STAT_AREA %in% c(stat_areas_closed) ~ \"yes\", TRUE ~ NA_character_))\nall_psc_impacted_cluster$inside[is.na(all_psc_impacted_cluster$inside)] &lt;- \"no\" # NA cpue to 0s\n\n\n# -- inside catch -- #\n#isolate hauls occurring inside closed area\ngf_inside_cluster &lt;- subset(all_psc_impacted_cluster, inside == \"yes\")\n\n#sum gf and psc inside closed area for later calcs\ngf_inside_cluster2 &lt;- gf_inside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, PROCESSING_SECTOR) %&gt;%\n  summarise(\n    tons_gf_inside_wk = sum(GF_TOTAL_CATCH_MT),\n    psc_measure_inside_wk = sum(PSC_TOTAL_COUNT)\n  )\n\n# -- outside catch -- #\n#isolate the hauls that occurred outside the closed area\ngf_outside_cluster &lt;- subset(all_psc_impacted_cluster, inside == \"no\")\n\ngf_outside_cluster2 &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, PROCESSING_SECTOR) %&gt;%\n  summarise(\n    tons_gf_outside_wk = sum(GF_TOTAL_CATCH_MT),\n    psc_measure_outside_wk = sum(PSC_TOTAL_COUNT)\n  )\n\n\n# summarize mean psc rates and calculate ratio of means  ---\n\nsum.stat.timeseries.gf_all &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, STAT_AREA, PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_wk = sum(GF_TOTAL_CATCH_MT),\n    mean_psc_wk = mean(PSC_TOTAL_COUNT),\n    mean_gf_tons_wk = mean(GF_TOTAL_CATCH_MT)) \n\n#ratio\nsum.stat.timeseries.gf_all$mean_psc_rate_wk &lt;- sum.stat.timeseries.gf_all$mean_psc_wk/sum.stat.timeseries.gf_all$mean_gf_tons_wk\n\n\n# Proportions by YEAR and STAT_AREA  ---\n\n#isolate gf catch by week\ngf.outside.stat &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE, STAT_AREA, PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_annual_stat = sum(GF_TOTAL_CATCH_MT)\n  )\n\n# sum all catch outside\ngf.outside.annually &lt;- gf_outside_cluster %&gt;%\n  group_by(YEAR, WEEK_END_DATE,  PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_annual = sum(GF_TOTAL_CATCH_MT))\n\n#join the the sums back to main\nsum.stat.timeseries.gf_all2 &lt;- dplyr::left_join(sum.stat.timeseries.gf_all, gf.outside.annually, by = c(\"YEAR\", \"WEEK_END_DATE\", \"PROCESSING_SECTOR\"))\nsum.stat.timeseries.gf_all3 &lt;- dplyr::left_join(sum.stat.timeseries.gf_all2, gf.outside.stat, by = c(\"YEAR\",\"WEEK_END_DATE\", \"STAT_AREA\", \"PROCESSING_SECTOR\"))\n\n# CALC PROPORTION OF OUTSIDE CATCH FOR EACH AREA\nsum.stat.timeseries.gf_all3$proportion_outside_wk &lt;- sum.stat.timeseries.gf_all3$tons_gf_annual_stat/sum.stat.timeseries.gf_all3$tons_gf_annual\nsum.stat.timeseries.gf_all3 &lt;- as.data.frame(sum.stat.timeseries.gf_all3)"
  },
  {
    "objectID": "FMM.html#plot-weekly-proportions",
    "href": "FMM.html#plot-weekly-proportions",
    "title": "Proportional Groundfish Redistribution",
    "section": "9. Plot Weekly Proportions",
    "text": "9. Plot Weekly Proportions\nThis plot shows the proportions of groundfish catch for the 20 adjacent stat areas outside of the closure. These proportions will be what displaced catch is applied to, under the assumption that the fishery will meet the same overall total catch.\n\n\nCode\n#proportion\nsum.stat.timeseries.gf_all_shp &lt;- dplyr::left_join(stat.areas.timeseries, sum.stat.timeseries.gf_all3, by=c(\"YEAR\", \"STAT_AREA\"))\nsum.stat.timeseries.gf_all_shp &lt;- terra::na.omit(sum.stat.timeseries.gf_all_shp, \"PROCESSING_SECTOR\")\n\npropdat &lt;- sum.stat.timeseries.gf_all_shp\npropdat$label &lt;- round(propdat$proportion_outside_wk, 2)\n\nggplot() +\n  tidyterra::geom_spatvector(data=subset(propdat, propdat$proportion_outside_wk&gt;0), aes(fill=proportion_outside_wk), alpha = 0.8, col=NA, na.rm=TRUE) +\n  scale_fill_distiller(palette = \"GnBu\", name = \"Proportion of GF Catch\") +\n  tidyterra::geom_spatvector(data = closure2, aes(color = \"Closure\"), \n                             fill = NA, alpha = 0.5, lwd = 0.5) +\n  scale_color_manual(values = c(\"Closure\" = \"red\"), name = NULL) +\n  facet_wrap(~WEEK_END_DATE, ncol=5) +\n  theme_bw() + theme(plot.title = element_text(hjust = 0.5), axis.title = element_blank())\n\n\n\n\n\n\n\n\nFigure 3: Simulated weekly GF Catch Proportions."
  },
  {
    "objectID": "FMM.html#calculate-weekly-and-annual-summary-statistics",
    "href": "FMM.html#calculate-weekly-and-annual-summary-statistics",
    "title": "Proportional Groundfish Redistribution",
    "section": "10. Calculate Weekly and Annual Summary Statistics",
    "text": "10. Calculate Weekly and Annual Summary Statistics\n\n\nCode\n#| label: summary-stats\n#| echo: false\n\n#join catch from inside area\ntotal.join &lt;- dplyr::left_join(sum.stat.timeseries.gf_all3,\n                               gf_inside_cluster2 %&gt;% dplyr::select(YEAR, WEEK_END_DATE, PROCESSING_SECTOR, tons_gf_inside_wk),\n                               by=c(\"YEAR\", \"WEEK_END_DATE\",  \"PROCESSING_SECTOR\"))\n\n#NAs to 0s to remove weeks where no catch happened inside the closed area\ntotal.join$tons_gf_inside_wk[is.na(total.join$tons_gf_inside_wk)] &lt;- 0\n\n#multiply weekly displaced catch by the outside proportions\ntotal.join$displaced_gf_catch_wk &lt;- total.join$tons_gf_inside_wk * total.join$proportion_outside_wk\n\n#multiply PSC rate by new gf catch\ntotal.join$new_PSC_wk &lt;- total.join$displaced_gf_catch_wk * total.join$mean_psc_rate_wk\n\n\n#summarize by week and sector\ntotal.join2 &lt;- total.join %&gt;% group_by(YEAR, WEEK_END_DATE, PROCESSING_SECTOR) %&gt;%\n  reframe(\n    tons_gf_inside_wk = max(tons_gf_inside_wk),\n    displaced_gf_catch_wk = sum(displaced_gf_catch_wk),\n    new_PSC_wk = sum(new_PSC_wk),\n    mean_psc_rate_wk = mean(mean_psc_rate_wk))\n\n#join the status quo inside psc numbers\ntotal.join3 &lt;- dplyr::left_join(total.join2,\n                                gf_inside_cluster2 %&gt;% dplyr::select(YEAR, WEEK_END_DATE, PROCESSING_SECTOR, psc_measure_inside_wk),\n                                by=c(\"YEAR\", \"WEEK_END_DATE\", \"PROCESSING_SECTOR\"))\n#NAs to 0s\ntotal.join3$psc_measure_inside_wk[is.na(total.join3$psc_measure_inside_wk)] &lt;- 0\n\n#subtract the PSC caught inside the area\ntotal.join3$net_change_PSC_wk &lt;- total.join3$new_PSC_wk - total.join3$psc_measure_inside_wk\n\ntotal.join.plot &lt;- total.join3\n\n\n#sum est changes for annual numbers\ntotal.join.plot.annual &lt;- total.join.plot %&gt;%\n  group_by(YEAR) %&gt;%\n  reframe(\n    est_change_fleet = sum(net_change_PSC_wk)\n  )"
  },
  {
    "objectID": "FMM.html#status-quo-comparison",
    "href": "FMM.html#status-quo-comparison",
    "title": "Proportional Groundfish Redistribution",
    "section": "11. Status Quo Comparison",
    "text": "11. Status Quo Comparison\n\n\nCode\n# --- total by year (only estimated change) with status quo numbers --- #\ntotal.join.plot.annual2 &lt;- dplyr::left_join(all_psc_status_quo_annual, total.join.plot.annual,  by=c(\"YEAR\"))\ntotal.join.plot.annual2$est_change_fleet[is.na(total.join.plot.annual2$est_change_fleet)] &lt;- 0\ntotal.join.plot.annual2$net_new_PSC &lt;- total.join.plot.annual2$sum_psc_status_quo + total.join.plot.annual2$est_change_fleet\ntotal.join.plot.annual2$LABEL &lt;- paste0(\"SPECIES\")\ncolnames(total.join.plot.annual2) &lt;-  c(\"YEAR\",  \"psc_statusquo\", \"psc_change\", \"net_new_PSC\",\"LABEL\")\ntotal.join.plot.annual3 &lt;- total.join.plot.annual2 %&gt;% pivot_longer(\n  cols = c(\"net_new_PSC\", \"psc_statusquo\"),\n  names_to = \"psc_type\",\n  names_prefix = \"psc_\",\n  values_to = \"psc_amount\",\n  values_drop_na = TRUE\n)\n\n\n# #plot\nggplot(total.join.plot.annual3, aes(x = YEAR, y = psc_amount, fill = psc_type))  + ggtitle(paste0(spp_title, \": \", title_name)) +\n  geom_bar(stat = \"identity\", position = \"dodge\") + theme_bw() + labs(x=\"Year\", y=\"Estimated Annual PSC (# Fish)\") +\n  scale_fill_brewer(palette = \"Paired\", name=\"Closure\", labels=c(title_name, \"Status Quo\")) +\n  theme(plot.title = element_text(hjust = 0.5)) \n\n\n\n\n\n\n\n\nFigure 4"
  },
  {
    "objectID": "FMM.html#final-summary-statistics-table",
    "href": "FMM.html#final-summary-statistics-table",
    "title": "Proportional Groundfish Redistribution",
    "section": "12. Final Summary Statistics Table",
    "text": "12. Final Summary Statistics Table\n\n\nCode\n#final summary table\nfinal.summary.table &lt;- total.join.plot.annual2 %&gt;% dplyr::select(YEAR, psc_statusquo, net_new_PSC, psc_change)\nfinal.summary.table &lt;- as.data.frame(final.summary.table)\ncolnames(final.summary.table) &lt;- c(\"year\", \"PSC_status_quo\", \"PSC_closure\", \"Net_Change\")\nfinal.summary.table$percent_change &lt;- final.summary.table$Net_Change / final.summary.table$PSC_status_quo *100\nprint(final.summary.table)\n\n\n  year PSC_status_quo PSC_closure Net_Change percent_change\n1 2021         692.42    604.9763  -87.44367      -12.62870\n2 2022         734.77    638.7395  -96.03051      -13.06946\n3 2023         686.12    608.0064  -78.11362      -11.38483"
  },
  {
    "objectID": "index.html#bootstrap",
    "href": "index.html#bootstrap",
    "title": "Proportional Fleet Redistribution",
    "section": "11. Bootstrap",
    "text": "11. Bootstrap\nTo provide a measure of uncertainty, we are bootstrapping 1,000 alternative scenarios by randomly shuffling the PSC rates where fishing is redistributed. We calculated a 95% Confidence Interval using the middle 95% of all simulated outcomes (between 2.5th and 97.5th percentiles).\n\n\nCode\n# Create a base dataframe that keeps STAT_AREA for resampling\ndf_bs_base &lt;- total.join %&gt;%\n  left_join(gf_inside_cluster2 %&gt;% \n              select(YEAR, WEEK_END_DATE, PROCESSING_SECTOR, psc_measure_inside_wk),\n            by = c(\"YEAR\", \"WEEK_END_DATE\", \"PROCESSING_SECTOR\")) %&gt;%\n  mutate(psc_measure_inside_wk = replace_na(psc_measure_inside_wk, 0),\n         displaced_gf_catch_wk = tons_gf_inside_wk * proportion_outside_wk)\n\nset.seed(345)\nn_iterations &lt;- 1000\nweeks &lt;- unique(df_bs_base$WEEK_END_DATE)\nboot_results &lt;- matrix(NA, nrow = n_iterations, ncol = length(weeks))\ncolnames(boot_results) &lt;- weeks\n\nfor(i in 1:n_iterations) {\n  \n  # Temporary storage for this iteration\n  new_psc_iteration &lt;- numeric(nrow(df_bs_base))\n  \n  for(w in weeks) {\n    wk_indices &lt;- which(df_bs_base$WEEK_END_DATE == w)\n    \n    # THE FIX: Sample from the pool of all rates available this week\n    psc_pool &lt;- df_bs_base$mean_psc_rate_wk[wk_indices]\n    \n    # Randomly assign a rate from the pool to each STAT_AREA\n    sampled_rates &lt;- sample(psc_pool, size = length(wk_indices), replace = TRUE)\n    \n    # Calculate new PSC: (Fixed Displaced Catch) * (Randomly Sampled Rate)\n    new_psc_iteration[wk_indices] &lt;- df_bs_base$displaced_gf_catch_wk[wk_indices] * sampled_rates\n  }\n  \n  # Summarize results for this iteration\n  df_iter &lt;- df_bs_base\n  df_iter$new_psc_boot &lt;- new_psc_iteration\n  \n  iter_summary &lt;- df_iter %&gt;%\n    group_by(WEEK_END_DATE) %&gt;%\n    summarise(\n      net_change = sum(new_psc_boot) - max(psc_measure_inside_wk),\n      .groups = \"drop\"\n    )\n  \n  for(j in seq_along(weeks)) {\n    boot_results[i, j] &lt;- iter_summary$net_change[iter_summary$WEEK_END_DATE == weeks[j]]\n  }\n}\n\n# 4. Calculate Confidence Intervals\nci_summary &lt;- data.frame(\n  WEEK_END_DATE = colnames(boot_results),\n  mean_net_change = colMeans(boot_results),\n  lower_ci = apply(boot_results, 2, quantile, probs = 0.025),\n  upper_ci = apply(boot_results, 2, quantile, probs = 0.975)\n)\n\n# 5. Merge with original modeled data for comparison\nfinal_comparison &lt;- left_join(ci_summary, total.join3 %&gt;% \n                                select(WEEK_END_DATE, net_change_PSC_wk), \n                              by = \"WEEK_END_DATE\")\n\n#summarize bootstrap data into annual\n# Convert matrix to long dataframe to join with Year info\nboot_long &lt;- as.data.frame(boot_results) %&gt;%\n  mutate(iteration = 1:n()) %&gt;%\n  pivot_longer(-iteration, names_to = \"WEEK_END_DATE\", values_to = \"net_change\") %&gt;%\n  mutate(WEEK_END_DATE = as.Date(WEEK_END_DATE),\n         YEAR = lubridate::year(WEEK_END_DATE))\n\n# Sum by iteration and year to get annual distribution of change\nboot_annual_dist &lt;- boot_long %&gt;%\n  group_by(iteration, YEAR) %&gt;%\n  summarise(annual_psc_change = sum(net_change), .groups = \"drop\")\n\n# Calculate CIs for the annual change\nboot_annual_ci &lt;- boot_annual_dist %&gt;%\n  group_by(YEAR) %&gt;%\n  summarise(\n    lower_change = quantile(annual_psc_change, 0.025),\n    upper_change = quantile(annual_psc_change, 0.975)\n  )"
  }
]